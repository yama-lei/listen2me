<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Listen2Me -  ç¾¤é‡Œåˆå‘å•¥äº†ï¼Ÿ</title>
  <link rel="icon" href="logo.png" type="image/x-icon">
  <style>
    :root{
      --primary: #0ea5e9; /* å¤©è“ */
      --primary-dark: #0288d1;
      --bg: #f3fbff;
      --card: #ffffff;
      --muted: #6b7280;
      --glass: rgba(255,255,255,0.6);
      --radius: 12px;
      --shadow: 0 8px 24px rgba(6,30,60,0.08);
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Noto Sans SC', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
      background: linear-gradient(180deg,var(--bg), #eef9ff);
      color:#0f1724;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding:2.5rem 1rem;
    }

    .wrap{max-width:1200px;margin:0 auto}

    /* Header */
    .header{
      display:flex;align-items:center;gap:1rem;padding:1rem 1.25rem;border-radius:18px;background:linear-gradient(90deg, rgba(14,165,233,0.12), rgba(2,136,209,0.06));box-shadow:var(--shadow);
    }
    .logo-wrap{display:flex;align-items:center;gap:1rem}
    .logo{
      width:68px;height:68px;border-radius:14px;display:inline-block;overflow:hidden;flex:0 0 68px;background:var(--card);box-shadow:0 6px 18px rgba(2,136,209,0.12);
    }
    .logo img{width:100%;height:100%;object-fit:contain;display:block}

    .title h1{font-size:1.25rem;margin-bottom:0.25rem;color:var(--primary-dark)}
    .title p{font-size:0.9rem;color:var(--muted)}

    /* grid */
    .dashboard{display:grid;grid-template-columns:1fr 360px;gap:1.25rem;margin-top:1.25rem}

    /* cards */
    .card{background:var(--card);border-radius:var(--radius);padding:1rem;box-shadow:var(--shadow)}
    .card h3{font-size:1.05rem;margin-bottom:0.75rem;color:var(--primary-dark);display:flex;align-items:center;gap:0.5rem}
    .card p{color:var(--muted)}

    .stat-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:0.75rem}
    .stat-item{background:linear-gradient(180deg, rgba(14,165,233,0.04), rgba(2,136,209,0.02));padding:0.75rem;border-radius:10px;text-align:center}
    .stat-number{font-size:1.6rem;font-weight:700;color:var(--primary-dark)}
    .stat-label{font-size:0.85rem;color:var(--muted);margin-top:0.35rem}

    .status-row{display:flex;align-items:center;gap:0.6rem}
    .status-indicator{width:12px;height:12px;border-radius:50%;display:inline-block}
    .status-online{background:#27ae60}
    .status-offline{background:#e74c3c}
    .status-warning{background:#f59e0b}

    .group-list{display:flex;gap:0.5rem;flex-wrap:wrap}
    .group-badge{background:linear-gradient(90deg,var(--primary),var(--primary-dark));color:white;padding:0.35rem 0.7rem;border-radius:999px;font-size:0.82rem}

    .event-list{max-height:420px;overflow:auto;display:flex;flex-direction:column;gap:0.6rem;padding-right:4px}
    .event-item{padding:0.75rem;border-radius:10px;background:linear-gradient(180deg, #ffffff, rgba(14,165,233,0.03));border-left:4px solid var(--primary);box-shadow:0 3px 10px rgba(2,6,23,0.04)}
    .event-item.todo{border-left-color:#ef4444}
    .event-item.notification{border-left-color:#f59e0b}
    .event-item.entertainment{border-left-color:#8b5cf6}
    .event-title{font-weight:600;margin-bottom:0.35rem}
    .event-meta{font-size:0.82rem;color:var(--muted)}

    .controls{display:flex;gap:0.5rem;flex-wrap:wrap}
    .button{background:var(--primary);color:white;border:none;padding:0.6rem 0.9rem;border-radius:10px;cursor:pointer;font-weight:600;box-shadow:0 6px 18px rgba(14,165,233,0.12)}
    .button:hover{background:var(--primary-dark);transform:translateY(-1px)}
    .button.ghost{background:transparent;color:var(--primary-dark);border:1px solid rgba(14,165,233,0.12);box-shadow:none}

    .rss-links{display:flex;gap:0.5rem;flex-wrap:wrap}
    .rss-link{display:inline-flex;align-items:center;gap:0.5rem;padding:0.45rem 0.75rem;border-radius:8px;background:rgba(14,165,233,0.04);text-decoration:none;color:var(--primary-dark);font-weight:600}

    .right-column{display:flex;flex-direction:column;gap:1rem}

    @media (max-width:980px){
      .dashboard{grid-template-columns:1fr;}
      .logo{width:56px;height:56px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="header" role="banner">
      <div class="logo-wrap">
        <div class="logo" aria-hidden="true">
          <img src="logo.png" alt="Listen2Me" />
        </div>
        <div class="title">
          <a href="https://github.com/yama-lei/listen2me" style="text-decoration: none;"><h1>Listen2Me</h1></a>
          <p>QQç¾¤èŠæ¶ˆæ¯è‡ªåŠ¨åŒ– Â· äº‹ä»¶è¯†åˆ«ä¸å¾…åŠç”Ÿæˆ</p>
        </div>
      </div>
      
      <div style="margin-left:auto;display:flex;gap:0.5rem;align-items:center">
        <button class="button ghost" onclick="location.reload();">åˆ·æ–°</button>
        <button class="button" onclick="triggerAnalysis(this)">æ‰‹åŠ¨è§¦å‘AIåˆ†æ</button>
      </div>
    </header>

    <main class="dashboard" role="main" aria-live="polite">
      <section style="display:flex;flex-direction:column;gap:1rem">
        <div class="card" aria-labelledby="sys-title">
          <h3 id="sys-title">ğŸ”§ ç³»ç»ŸçŠ¶æ€</h3>
          <div class="stat-grid">
            <div class="stat-item">
              <div class="stat-number" id="totalMessages">-</div>
              <div class="stat-label">æ€»æ¶ˆæ¯æ•°</div>
            </div>
            <div class="stat-item">
              <div class="stat-number" id="processedMessages">-</div>
              <div class="stat-label">å·²å¤„ç†</div>
            </div>
            <div class="stat-item">
              <div class="stat-number" id="totalEvents">-</div>
              <div class="stat-label">è¯†åˆ«äº‹ä»¶</div>
            </div>
            <div class="stat-item">
              <div class="stat-number" id="processingRate">-</div>
              <div class="stat-label">å¤„ç†ç‡</div>
            </div>
          </div>

          <div style="margin-top:0.8rem;display:flex;justify-content:space-between;align-items:center">
            <div class="status-row">
              <span class="status-indicator status-offline" id="systemStatus"></span>
              <div id="systemStatusText">åŠ è½½ä¸­...</div>
            </div>
            <div style="font-size:0.9rem;color:var(--muted)">æœ€åæ›´æ–°: <span id="lastUpdate">-</span></div>
          </div>
        </div>

        <div class="card" aria-labelledby="events-title">
          <h3 id="events-title">ğŸ“‹ æœ€è¿‘è¯†åˆ«çš„äº‹ä»¶</h3>
          <div class="event-list" id="eventList">
            <div style="text-align:center;color:var(--muted);padding:2rem">åŠ è½½ä¸­â€¦</div>
          </div>
        </div>

      </section>

      <aside class="right-column" aria-label="ä¾§æ ">
        <div class="card">
          <h3>ğŸ“¡ ç›‘å¬é…ç½®</h3>
          <p><strong>WebSocket:</strong></p>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:0.5rem">
            <div><span class="status-indicator" id="wsStatus"></span> <span id="wsStatusText">æ£€æŸ¥ä¸­â€¦</span></div>
            <div style="font-size:0.85rem;color:var(--muted)"><small id="wsDetails"></small></div>
          </div>

          <div style="margin-top:0.8rem">
            <p style="margin-bottom:0.35rem"><strong>ç›‘å¬ç¾¤ï¼š</strong></p>
            <div class="group-list" id="groupList"><div style="color:var(--muted)">åŠ è½½ä¸­â€¦</div></div>
          </div>

          <div style="margin-top:0.8rem">
            <p><strong>AIåˆ†æ:</strong> <span id="aiStatus">æ£€æŸ¥ä¸­â€¦</span></p>
          </div>
        </div>

        <div class="card">
          <h3>â° å®šæ—¶ä»»åŠ¡</h3>
          <div id="schedulerInfo"><div style="color:var(--muted)">åŠ è½½ä¸­â€¦</div></div>
        </div>

        <div class="card">
          <h3>ğŸ“° RSSè®¢é˜…</h3>
          <div style="margin-bottom:0.5rem;color:var(--muted)">è®¢é˜…ä»¥ä¸‹é“¾æ¥è·å–æœ€æ–°äº‹ä»¶</div>
          <div class="rss-links">
            <a class="rss-link" href="/rss" target="_blank">å…¨éƒ¨äº‹ä»¶</a>
            <a class="rss-link" href="/rss/todo" target="_blank">å¾…åŠ</a>
            <a class="rss-link" href="/rss/notification" target="_blank">é€šçŸ¥</a>
          </div>
          <div style="margin-top:0.8rem;font-size:0.9rem;color:var(--muted)" id="rssStats">åŠ è½½ä¸­â€¦</div>
        </div>
      </aside>
    </main>
  </div>

  <script>
    let isAnalyzing = false;

    document.addEventListener('DOMContentLoaded', () => {
      refreshAll();
      setInterval(() => { if (!isAnalyzing) refreshAll(); }, 30000);
    });

    function refreshAll(){
      loadSystemStatus(); loadEvents(); loadSchedulerStatus(); loadRSSStats(); loadWebSocketStatus();
    }

    async function loadSystemStatus(){
      try{
        const [statusRes, statsRes, analysisRes] = await Promise.all([
          fetch('/api/status'), fetch('/api/stats'), fetch('/api/analysis/stats')
        ]);
        const status = await statusRes.json();
        const stats = await statsRes.json();
        const analysis = await analysisRes.json();

        document.getElementById('totalMessages').textContent = status.total_received || '0';
        document.getElementById('processedMessages').textContent = status.total_processed || '0';
        document.getElementById('totalEvents').textContent = stats.total_events_found || '0';
        document.getElementById('processingRate').textContent = status.processing_rate || '0%';

        const statusIndicator = document.getElementById('systemStatus');
        const statusText = document.getElementById('systemStatusText');

        if (analysis.analysis_enabled) {
          statusIndicator.className = 'status-indicator status-online';
          statusText.textContent = 'AIåˆ†æå·²å¯ç”¨';
        } else {
          statusIndicator.className = 'status-indicator status-warning';
          statusText.textContent = 'AIåˆ†ææœªé…ç½®';
        }

        const groupList = document.getElementById('groupList');
        if (status.listened_groups && status.listened_groups.length) {
          groupList.innerHTML = status.listened_groups.map(g => `<span class="group-badge">${escapeHtml(g)}</span>`).join('');
        } else {
          groupList.innerHTML = '<span style="color:#ef4444">æœªé…ç½®ç›‘å¬ç¾¤èŠ</span>';
        }

        const aiStatus = document.getElementById('aiStatus');
        if (analysis.analysis_enabled) {
          const lastAnalysis = analysis.last_analysis_time ? new Date(analysis.last_analysis_time).toLocaleString('zh-CN') : 'ä»æœªè¿è¡Œ';
          aiStatus.innerHTML = `<span style="color:#27ae60">å·²å¯ç”¨</span>ï¼ˆæœ€ååˆ†æ: ${lastAnalysis}ï¼‰`;
        } else {
          aiStatus.innerHTML = '<span style="color:#ef4444">æœªå¯ç”¨</span>';
        }

        document.getElementById('lastUpdate').textContent = new Date().toLocaleString('zh-CN');
      }catch(err){
        console.error(err); showError('åŠ è½½ç³»ç»ŸçŠ¶æ€å¤±è´¥: '+ (err.message || err));
      }
    }

    async function loadEvents(){
      try{
        const res = await fetch('/api/events?limit=20');
        const events = await res.json();
        const list = document.getElementById('eventList');
        if (!events || events.length === 0) {
          list.innerHTML = '<div style="text-align:center;color:var(--muted);padding:2rem">æš‚æ— è¯†åˆ«çš„äº‹ä»¶</div>';
          return;
        }
        list.innerHTML = events.map(e => renderEventItem(e)).join('');
      }catch(err){
        console.error(err); document.getElementById('eventList').innerHTML = '<div class="card" style="background:transparent;padding:0"><div style="color:#ef4444">åŠ è½½äº‹ä»¶å¤±è´¥: '+escapeHtml(err.message || err)+'</div></div>';
      }
    }

    function renderEventItem(event){
      const typeEmoji = {'todo':'ğŸ“','notification':'ğŸ“¢','entertainment':'ğŸ‰'};
      const priorityEmoji = {'low':'ğŸ”µ','medium':'ğŸŸ¡','high':'ğŸ”´'};
      const createdAt = event.created_at ? new Date(event.created_at).toLocaleString('zh-CN') : '-';
      const dueDate = event.due_date ? new Date(event.due_date).toLocaleString('zh-CN') : '';
      const safeTitle = escapeHtml(event.title || 'æ— æ ‡é¢˜');
      const safeDesc = escapeHtml(event.description || '');
      return `
        <div class="event-item ${escapeHtml(event.event_type || '')}">
          <div class="event-title">${typeEmoji[event.event_type]||'ğŸ“„'} ${priorityEmoji[event.priority]||''} ${safeTitle}</div>
          <div style="margin:0.4rem 0;font-size:0.93rem;color:#0f1724;">${safeDesc}</div>
          <div class="event-meta">ç¾¤èŠ: ${escapeHtml(event.group_name || event.group_id || '-')} | åˆ›å»º: ${createdAt} ${dueDate? '| æˆªæ­¢: '+dueDate : ''}</div>
        </div>`;
    }

    async function loadSchedulerStatus(){
      try{
        const res = await fetch('/api/scheduler/status');
        const status = await res.json();
        const el = document.getElementById('schedulerInfo');
        el.innerHTML = (status.jobs || []).map(job => {
          const nextRun = job.nextDate ? new Date(job.nextDate).toLocaleString('zh-CN') : 'æœªå®‰æ’';
          const lastRun = job.lastDate ? new Date(job.lastDate).toLocaleString('zh-CN') : 'ä»æœªè¿è¡Œ';
          return `<div style="padding:0.6rem;border-radius:8px;background:linear-gradient(180deg, rgba(2,136,209,0.03), rgba(14,165,233,0.02));margin-bottom:0.6rem"><div style="font-weight:600;margin-bottom:0.35rem"><span class="status-indicator ${job.running? 'status-online': 'status-offline'}"></span> ${escapeHtml(job.description||'ä»»åŠ¡')}</div><div style="font-size:0.88rem;color:var(--muted)">ä¸‹æ¬¡è¿è¡Œ: ${nextRun}<br>ä¸Šæ¬¡è¿è¡Œ: ${lastRun}</div></div>`;
        }).join('') || '<div style="color:var(--muted)">æ— å®šæ—¶ä»»åŠ¡</div>';
      }catch(err){ console.error(err); document.getElementById('schedulerInfo').innerHTML = '<div style="color:#ef4444">åŠ è½½è°ƒåº¦å™¨çŠ¶æ€å¤±è´¥: '+escapeHtml(err.message||err)+'</div>'; }
    }

    async function loadRSSStats(){
      try{
        const res = await fetch('/api/rss/stats');
        const stats = await res.json();
        const el = document.getElementById('rssStats');
        const byType = stats.by_type || {};
        el.innerHTML = `<div><strong>æ´»è·ƒäº‹ä»¶:</strong> ${stats.total_active_events || 0}</div><div style="margin-top:0.4rem;color:var(--muted)">${Object.entries(byType).map(([k,v])=> `${escapeHtml(k)}: ${v.count}`).join(' | ')}</div>`;
      }catch(err){ console.error(err); document.getElementById('rssStats').innerHTML = '<div style="color:#ef4444">åŠ è½½RSSç»Ÿè®¡å¤±è´¥</div>'; }
    }

    async function loadWebSocketStatus(){
      try{
        const res = await fetch('/api/websocket/status');
        const data = await res.json();
        const statusIndicator = document.getElementById('wsStatus');
        const statusText = document.getElementById('wsStatusText');
        const details = document.getElementById('wsDetails');

        if (data.connected && data.napCatCount > 0) {
          statusIndicator.className = 'status-indicator status-online';
          statusText.textContent = `å·²è¿æ¥ (${data.napCatCount} ä¸ªNapCat)`;
          const napCatClients = (data.clients||[]).filter(c=>c.isNapCat);
          details.textContent = napCatClients.map(c=>`NapCat(${c.selfId||'?'}) ${c.ip||''} ${c.connectedAt? 'è¿æ¥äº '+ new Date(c.connectedAt).toLocaleString('zh-CN') : ''}`).join('\n');
        } else if ((data.clientCount||0) > 0) {
          statusIndicator.className = 'status-indicator status-warning';
          statusText.textContent = `æœ‰è¿æ¥ä½†éNapCat (${data.clientCount} ä¸ª)`;
          details.textContent = 'ç­‰å¾…NapCatè¿æ¥â€¦';
        } else {
          statusIndicator.className = 'status-indicator status-offline';
          statusText.textContent = 'ç­‰å¾…è¿æ¥';
          details.textContent = `WebSocket æœåŠ¡: ç«¯å£ ${data.server?.port || 'Unknown'}`;
        }
      }catch(err){ console.error(err); document.getElementById('wsStatus').className = 'status-indicator status-offline'; document.getElementById('wsStatusText').textContent = 'çŠ¶æ€è·å–å¤±è´¥'; document.getElementById('wsDetails').textContent = 'æ— æ³•è¿æ¥åˆ° WebSocket'; }
    }

    // è§¦å‘åˆ†æï¼Œæ¥å—æŒ‰é’®å…ƒç´ ä»¥ä¾¿åœ¨è¯·æ±‚æœŸé—´ç¦ç”¨å¹¶æ˜¾ç¤ºçŠ¶æ€
    async function triggerAnalysis(button){
      if (isAnalyzing) return;
      isAnalyzing = true;
      const original = button.innerHTML;
      button.innerHTML = 'åˆ†æä¸­...';
      button.disabled = true;
      try{
        const res = await fetch('/api/analysis/trigger',{method:'POST'});
        const result = await res.json();
        if (result.success) { showSuccess(`åˆ†æå®Œæˆï¼šå¤„ç† ${result.processed} æ¡ï¼Œè¯†åˆ« ${result.events?.length || 0} ä¸ªäº‹ä»¶`); refreshAll(); }
        else { showError('åˆ†æå¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯')); }
      }catch(err){ console.error(err); showError('è§¦å‘åˆ†æå¤±è´¥: '+(err.message||err)); }
      finally{ isAnalyzing = false; button.innerHTML = original; button.disabled = false; }
    }

    // åé¦ˆ / è¾…åŠ©
    function showError(message){
      const container = document.querySelector('.wrap');
      const d = document.createElement('div');
      d.style.cssText = 'background:#fff0f0;color:#b91c1c;padding:0.8rem;border-radius:10px;margin:0.8rem 0;box-shadow:0 6px 18px rgba(185,28,28,0.06)';
      d.textContent = message;
      container.insertBefore(d, container.firstChild);
      setTimeout(()=> d.remove(), 6000);
    }

    function showSuccess(message){
      const container = document.querySelector('.wrap');
      const d = document.createElement('div');
      d.style.cssText = 'background:#ecfdf5;color:#065f46;padding:0.8rem;border-radius:10px;margin:0.8rem 0;box-shadow:0 6px 18px rgba(6,95,70,0.06)';
      d.textContent = message;
      container.insertBefore(d, container.firstChild);
      setTimeout(()=> d.remove(), 5000);
    }

    // ç®€å•çš„ XSS è½¬ä¹‰ï¼ˆç”¨äºæ¸²æŸ“æœåŠ¡ç«¯è¿”å›çš„å°‘é‡æ–‡æœ¬ï¼‰
    function escapeHtml(str){ if (str==null) return ''; return String(str).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  </script>
</body>
</html>
